# -------------------------------------------------
# 1️⃣ 基礎映像：最小化的 Node + Alpine
# -------------------------------------------------
FROM node:20-alpine AS runtime

# -------------------------------------------------
# 2️⃣ 工作目錄
# -------------------------------------------------
WORKDIR /app

# -------------------------------------------------
# 3️⃣ 只拷貝 npm 相關檔案（避免帶入不必要檔案）
# -------------------------------------------------
COPY package*.json ./
# 若有 lock 檔，會同時被 copy
# COPY npm-shrinkwrap.json ./

# -------------------------------------------------
# 4️⃣ 若你的套件需要編譯原生模組，先安裝 build tools
#    （如果全都是純 JavaScript，可直接移除）
# -------------------------------------------------
# RUN apk add --no-cache python3 make g++ pkgconfig

# -------------------------------------------------
# 5️⃣ 安裝 **production** 相依（不含 devDependencies）
#    使用 `--only=production` 以兼容所有 npm 版本
# -------------------------------------------------
ENV NODE_ENV=production
RUN npm ci --only=production && \
    npm cache clean --force

# -------------------------------------------------
# 6️⃣ 拷貝應用程式原始碼（src/... 以及其他必要檔案）
# -------------------------------------------------
COPY src/ ./src/
# 若有其他需要的目錄（例如 public/、config/）自行加入
# COPY public/ ./public/

# -------------------------------------------------
# 7️⃣ 暴露服務埠（依 server.js 預設為 3000，可自行調整）
# -------------------------------------------------
EXPOSE 3000

# -------------------------------------------------
# 8️⃣ 設定容器啟動指令
# -------------------------------------------------
CMD ["npm", "run", "start"]
